<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, viewport-fit=cover" />
    <title>Mini Shop | Telegram-магазин</title>
    <meta name="description" content="Mini Shop — быстрый Telegram-магазин с категориями, корзиной и онлайн-оплатой." />
    <meta name="keywords" content="telegram shop, мини-магазин, telegram mini app, доставка, онлайн магазин" />
    <meta name="author" content="Mini Shop" />
    <meta name="theme-color" content="#09090b" />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />

    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Mini Shop",
        "url": "https://miniapp.local",
        "applicationCategory": "ShoppingApplication",
        "operatingSystem": "All",
        "description": "Telegram mini app для оформления заказов и управления каталогом."
      }
    </script>

    <!-- Telegram WebApp Script -->
    <script>
      // Фильтруем логи Telegram WebView перед загрузкой скрипта
      (function() {
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalInfo = console.info;
        const originalError = console.error;
        
        const filterTelegramLogs = (...args) => {
          // Проверяем все аргументы на наличие Telegram логов
          for (const arg of args) {
            const str = typeof arg === 'string' ? arg : (arg?.toString?.() || JSON.stringify(arg) || '');
            if (str.includes('[Telegram.WebView]') || str.includes('postEvent')) {
              return false;
            }
          }
          return true;
        };
        
        console.log = function(...args) {
          if (filterTelegramLogs(...args)) {
            originalLog.apply(console, args);
          }
        };
        
        console.warn = function(...args) {
          if (filterTelegramLogs(...args)) {
            originalWarn.apply(console, args);
          }
        };
        
        console.info = function(...args) {
          if (filterTelegramLogs(...args)) {
            originalInfo.apply(console, args);
          }
        };
        
        console.error = function(...args) {
          if (filterTelegramLogs(...args)) {
            originalError.apply(console, args);
          }
        };
      })();
    </script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
      // Предотвращаем автоматический зум iOS Safari при фокусе на input/textarea
      (function() {
        let viewport = document.querySelector('meta[name="viewport"]');
        let initialScale = 1;
        
        function preventZoom() {
          if (viewport) {
            viewport.setAttribute('content', 
              'width=device-width, initial-scale=' + initialScale + ', maximum-scale=' + initialScale + ', minimum-scale=' + initialScale + ', user-scalable=no, viewport-fit=cover'
            );
          }
        }
        
        function resetZoom() {
          if (viewport) {
            viewport.setAttribute('content', 
              'width=device-width, initial-scale=' + initialScale + ', maximum-scale=' + initialScale + ', minimum-scale=' + initialScale + ', user-scalable=no, viewport-fit=cover'
            );
          }
          // Принудительно сбрасываем масштаб
          document.body.style.zoom = '1';
          document.body.style.transform = 'scale(1)';
          if (document.documentElement.style.zoom !== undefined) {
            document.documentElement.style.zoom = '1';
            document.documentElement.style.transform = 'scale(1)';
          }
          // Сбрасываем масштаб для всех input/textarea
          const inputs = document.querySelectorAll('input, textarea');
          inputs.forEach(function(input) {
            input.style.zoom = '1';
            input.style.transform = 'scale(1)';
          });
        }
        
        // Применяем при загрузке
        preventZoom();
        
        // Применяем при изменении ориентации
        window.addEventListener('orientationchange', function() {
          setTimeout(preventZoom, 100);
        });
        
        // Применяем при фокусе на input/textarea
        function attachZoomPrevention() {
          const inputs = document.querySelectorAll('input, textarea');
          inputs.forEach(function(input) {
            // Удаляем старые обработчики если есть
            input.removeEventListener('focus', resetZoom);
            input.removeEventListener('blur', resetZoom);
            input.removeEventListener('touchstart', resetZoom);
            input.removeEventListener('click', resetZoom);
            
            // Добавляем новые обработчики
            input.addEventListener('focus', function() {
              resetZoom();
              setTimeout(resetZoom, 50);
              setTimeout(resetZoom, 100);
            }, { passive: true });
            input.addEventListener('blur', resetZoom, { passive: true });
            input.addEventListener('touchstart', function(e) {
              resetZoom();
              e.preventDefault();
            }, { passive: false });
            input.addEventListener('touchend', resetZoom, { passive: true });
            input.addEventListener('click', resetZoom, { passive: true });
            
            // Принудительно устанавливаем font-size для textarea
            if (input.tagName === 'TEXTAREA') {
              input.style.fontSize = '16px';
              input.style.webkitTextSizeAdjust = '100%';
            }
          });
        }
        
        document.addEventListener('DOMContentLoaded', attachZoomPrevention);
        
        // Также применяем при динамическом добавлении элементов
        const observer = new MutationObserver(function(mutations) {
          mutations.forEach(function(mutation) {
            mutation.addedNodes.forEach(function(node) {
              if (node.nodeType === 1) {
                if (node.tagName === 'INPUT' || node.tagName === 'TEXTAREA') {
                  // Принудительно устанавливаем font-size для textarea
                  if (node.tagName === 'TEXTAREA') {
                    node.style.fontSize = '16px';
                    node.style.webkitTextSizeAdjust = '100%';
                  }
                  node.addEventListener('focus', resetZoom, { passive: true });
                  node.addEventListener('blur', resetZoom, { passive: true });
                  node.addEventListener('touchstart', resetZoom, { passive: true });
                  node.addEventListener('click', resetZoom, { passive: true });
                }
                const inputs = node.querySelectorAll ? node.querySelectorAll('input, textarea') : [];
                inputs.forEach(function(input) {
                  if (input.tagName === 'TEXTAREA') {
                    input.style.fontSize = '16px';
                    input.style.webkitTextSizeAdjust = '100%';
                  }
                  input.addEventListener('focus', resetZoom, { passive: true });
                  input.addEventListener('blur', resetZoom, { passive: true });
                  input.addEventListener('touchstart', resetZoom, { passive: true });
                  input.addEventListener('click', resetZoom, { passive: true });
                });
              }
            });
            // Перепривязываем все обработчики после изменений
            attachZoomPrevention();
          });
        });
        
        if (document.body) {
          observer.observe(document.body, { childList: true, subtree: true });
        } else {
          document.addEventListener('DOMContentLoaded', function() {
            observer.observe(document.body, { childList: true, subtree: true });
          });
        }
      })();
    </script>
  </head>

  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
